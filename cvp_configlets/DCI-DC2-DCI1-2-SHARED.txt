no spanning-tree vlan-id 4093
!
vlan 4093
   name CORP_ROUTING
   trunk group PEER
!
vrf instance CORP
!
ip routing vrf CORP
!
interface Loopback1
   description VTEP
   ip address 10.2.2.198/32
!
interface Vxlan1
   vxlan source-interface Loopback1
   vxlan virtual-router encapsulation mac-address mlag-system-id
   vxlan udp-port 4789
   vxlan vrf CORP vni 5001
!
interface Vlan4093
   description CORP VRF Routing VLAN
   vrf CORP
   ip address unnumbered Loopback99
   ip ospf network point-to-point
   ip ospf area 0.0.0.0
!
ip prefix-list BLOCK-32s seq 100 permit 0.0.0.0/0 eq 32
ip prefix-list DC1-LEGACY-NETWORKS seq 100 permit 10.11.2.0/24
ip prefix-list DC1-LEGACY-NETWORKS seq 110 permit 10.11.3.0/24
ip prefix-list DC1-LEGACY-NETWORKS seq 120 permit 10.11.4.0/24
ip prefix-list DC1-LEGACY-NETWORKS seq 130 permit 10.251.0.0/16 le 32
ip prefix-list DC2-CORP-LOOPBACKS seq 100 permit 10.99.2.0/24 eq 32
ip prefix-list DC2-LEGACY-NETWORKS seq 100 permit 10.21.2.0/24
ip prefix-list DC2-LEGACY-NETWORKS seq 110 permit 10.21.3.0/24
ip prefix-list DC2-LEGACY-NETWORKS seq 120 permit 10.21.4.0/24
ip prefix-list DC2-LEGACY-NETWORKS seq 130 permit 10.252.0.0/16 le 32
ip prefix-list DC3-LEGACY-NETWORKS seq 100 permit 10.31.2.0/24
ip prefix-list DC3-LEGACY-NETWORKS seq 110 permit 10.31.3.0/24
ip prefix-list DC3-LEGACY-NETWORKS seq 120 permit 10.31.4.0/24
ip prefix-list DC3-LEGACY-NETWORKS seq 130 permit 10.253.0.0/16 le 32
ip community-list DC1-COMMUNITY-LIST permit 65100:11111
ip community-list DC2-COMMUNITY-LIST permit 65200:22222
ip community-list DC3-COMMUNITY-LIST permit 65300:33333
ip community-list DC2-FABRIC-COMMUNITY permit 22222:22222
!
! Prevent Redistribution Loop by blocking set communities
!
route-map DC2-BGP-TO-OSPF deny 10
   match community DC1-COMMUNITY-LIST
!
route-map DC2-BGP-TO-OSPF deny 20
   match community DC2-COMMUNITY-LIST
!
route-map DC2-BGP-TO-OSPF deny 30
   match community DC3-COMMUNITY-LIST
!
! With Symmetric IRB, /32s will be generated.  If not desired, 
! they can be blocked by prefix length.
!
!route-map DC2-BGP-TO-OSPF permit 40
!   match ip address prefix-list DC2-CORP-LOOPBACKS
!
!route-map DC2-BGP-TO-OSPF deny 50
!   match ip address prefix-list BLOCK-32s
!
! Need a policy to prefer local DC when connected to common Core
! Works without, but suboptimal pathing occurs
! Could use Prefix-List or BGP Community Originated From Leaves (as shown)
!
route-map DC2-BGP-TO-OSPF permit 100
   match community DC2-FABRIC-COMMUNITY
   set metric-type type-1
!
! Allow all other routes from New Fabric to be advertised to Legacy
!
route-map DC2-BGP-TO-OSPF permit 999
!
! Set Standard Community Value based on Legacy DC of Origin
!
route-map DC2-OSPF-TO-BGP permit 110
   match ip address prefix-list DC1-LEGACY-NETWORKS
   set community community-list DC1-COMMUNITY-LIST
!
route-map DC2-OSPF-TO-BGP permit 120
   match ip address prefix-list DC2-LEGACY-NETWORKS
   set community community-list DC2-COMMUNITY-LIST
!
route-map DC2-OSPF-TO-BGP permit 130
   match ip address prefix-list DC3-LEGACY-NETWORKS
   set community community-list DC3-COMMUNITY-LIST
!
! Increase Admin Distance on EVPN Type 5 Routes for DC1 Prefixes
! This will prevent looping in the fabric and prefer local OSPF Routes
!
route-map DC2-LEGACY-LOCAL-EGRESS permit 100
   match community DC2-COMMUNITY-LIST
   set distance 240
!
! Allow all other incoming EVPN Routes
!
route-map DC2-LEGACY-LOCAL-EGRESS permit 999
!
router ospf 100 vrf CORP
   passive-interface default
   no passive-interface Ethernet51/1
   no passive-interface Ethernet52/1
   no passive-interface Vlan4093
   redistribute bgp route-map DC2-BGP-TO-OSPF
   max-lsa 12000
!
router bgp 65298
   maximum-paths 4
   distance bgp 20 200 200
   no bgp default ipv4-unicast
   timers bgp 5 15
   rd auto
   neighbor DC1-DCI-IPv4 peer group
   neighbor DC1-DCI-IPv4 remote-as 65198
   neighbor DC1-DCI-IPv4 send-community standard extended
   neighbor DC1-DCI-IPv4 maximum-routes 100000 warning-only
   neighbor DC1-DCI-EVPN peer group
   neighbor DC1-DCI-EVPN remote-as 65198
   neighbor DC1-DCI-EVPN update-source Loopback0
   neighbor DC1-DCI-EVPN ebgp-multihop 3
   neighbor DC1-DCI-EVPN send-community standard extended
   neighbor DC1-DCI-EVPN maximum-routes 100000 warning-only
   neighbor PEER peer group
   neighbor PEER remote-as 65298
   neighbor PEER next-hop-self
   neighbor PEER send-community standard extended
   neighbor PEER maximum-routes 100000 warning-only
   neighbor SPINE-IPv4 peer group
   neighbor SPINE-IPv4 remote-as 65200
   neighbor SPINE-IPv4 send-community standard extended
   neighbor SPINE-IPv4 maximum-routes 100000 warning-only
   neighbor SPINE-EVPN peer group
   neighbor SPINE-EVPN remote-as 65200
   neighbor SPINE-EVPN update-source Loopback0
   neighbor SPINE-EVPN ebgp-multihop 3
   neighbor SPINE-EVPN send-community standard extended
   neighbor SPINE-EVPN maximum-routes 100000 warning-only
   neighbor 10.2.1.1 peer group SPINE-EVPN
   neighbor 10.1.1.196 peer group DC1-DCI-EVPN
   neighbor 10.1.1.197 peer group DC1-DCI-EVPN
   redistribute connected route-map LOOPBACKS
   !
   address-family evpn
      neighbor DC1-DCI-EVPN activate
      neighbor DC1-DCI-EVPN route-map DC2-LEGACY-LOCAL-EGRESS in
      neighbor DC1-DCI-EVPN domain remote
      neighbor SPINE-EVPN activate
      neighbor SPINE-EVPN route-map DC2-LEGACY-LOCAL-EGRESS in
      neighbor default next-hop-self received-evpn-routes route-type ip-prefix inter-domain
   !
   address-family ipv4
      neighbor DC1-DCI-IPv4 activate
      neighbor PEER activate
      neighbor SPINE-IPv4 activate
   !
   vrf CORP
      route-target import evpn 5001:5001
      route-target export evpn 5001:5001
      redistribute connected
      redistribute ospf route-map DC2-OSPF-TO-BGP